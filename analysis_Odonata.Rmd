---
title: "preliminary_analysis_Odonata"
author: "Diana Bowler"
date: "24 januar 2018"
output:
  word_document: default
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

```

#Analysis of the Odonata data 

First step: read in the raw data file from the sMon data portal.
Sheet 5 of the workbook contains the raw data of occurrences.
Each row in the data frame is a species observation.


Select state for analysis

```{r}

state = "SH"
state = "Sa"

```


```{r warning=FALSE}

#library(gdata)
load(paste0("derived-data/juv_datafile_",state,".RData"))
df <- juv_datafile

```


#Data frame formatting

Step one: format the date and extract month, dat and year information.

```{r}

library(lubridate)
df$Date <- as.Date(df$Date,file="%Y-%m-%d")
df$month <- month(df$Date)
df$day <- yday(df$Date)
df$Year <- year(df$Date)

```

Step two: remove those with missing date entries

```{r}

df <- subset(df,!is.na(month))
summary(df)

```


#Data filtering

Filter one: focus on the months that were most sampled. The results suggest this is between April and September.

```{r}

table(df$month)

df <- subset(df, month %in% c(4:8))

```

Filter two: begin the time series from the first year with reasonable amount of data (i.e., number of records). 1981 seems like a good place to start. Also, we cut off 2017 incase the database is not up-to-date yet.

```{r}

table(df$Year)
df <- subset(df, Year>1982)
df <- subset(df, Year<2017)

```

#Data availability/Sampling effort checking

We can look at effort by: total number of records and average number of species seen per sampling day ("list length")

```{r}

library(sparta)

dataDiagnostics(taxa= as.character(df$Species), 
                site= as.character(df$MTB_Q), 
                time_period = df$Date)

#both list length and number of records increase over time

```

Summary info per species

```{r}

library(plyr)
(outSummary <- ddply(df,.(Species),summarise,
                     nuRecs=length(unique(Date)),
                     nuYears=length(unique(Year)),
                     nuSites=length(unique(MTB_Q))))

```

Identify species seen in 25% of years

```{r}

mainSpecies <- outSummary$Species[outSummary$nuYears > (length(unique(df$Year))/4)]
mainSpecies

```

Organise data using the sparta wrapper function

```{r, results='asis'}

source('R/sparta_wrapper_functions.R')

#define a visit
#df$visit <- paste(df$MTB_Q,df$Date,df$Beobachter,sep="_")
df$visit <- paste(df$MTB_Q,df$Date,sep="_")

occMatrix <- getOccurrenceMatrix(df)
listlengthDF <- getListLength(df)

#checks
all(row.names(occMatrix)==listlengthDF$surveyList)
listlengthDF[1:10,]

#plots
library(ggplot2)
qplot(nuSpecies,nuRecords,data=listlengthDF)
qplot(nuSpecies,RpS,data=listlengthDF)

```

#Run models over multiple species

Pull out 20 most common Species

```{r}

outSummary <- arrange(outSummary,desc(nuRecs))
(mySpecies <- outSummary$Species[1:20])
outSummary$nuRecs[1:20]

```

Run model with effort with all effort terms
```{r}

#run out each species
out <-llply(mySpecies,function(x){
  fitBugs(mySpecies=x)
})

save(out,file=paste0("out_nuSpecies_All_",state,".RData"))

```

Run model with number of records and expertise as effort terms

```{r}

#run out each species
out <-llply(mainSpecies,function(x){
  fitBugs(mySpecies=x,effort="nuRecs")
})

save(out,file=paste0("out_nuRecords_juveniles_",state,".RData"))

```


