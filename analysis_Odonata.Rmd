---
title: "preliminary_analysis_Odonata"
author: "Diana Bowler"
date: "24 januar 2018"
output:
  word_document: default
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

```

#Analysis of the Odonata data from Saarland

First step: read in the raw data file from the sMon data portal.
Sheet 5 of the workbook contains the raw data of occurrences.
Each row in the data frame is a species observation.

```{r warning=FALSE}

#library(gdata)
load("derived-data/juv_datafile.RData")
df <- juv_datafile

```


#Data frame formatting

Step one: format the date and extract month, dat and year information.

```{r}

library(lubridate)
df$Date <- as.Date(df$Date,file="%Y-%m-%d")
df$month <- month(df$Date)
df$day <- yday(df$Date)
df$Year <- year(df$Date)

```

Step two: remove those with missing date entries

```{r}

df <- subset(df,!is.na(month))
summary(df)

```


#Data filtering

Filter one: focus on the months that were most sampled. The results suggest this is between April and September.

```{r}

table(df$month)

df <- subset(df, month %in% c(4:8))

```

Filter two: begin the time series from the first year with reasonable amount of data (i.e., number of records). 1981 seems like a good place to start. Also, we cut off 2017 incase the database is not up-to-date yet.

```{r}

table(df$Year)
df <- subset(df, Year>1982)
df <- subset(df, Year<2017)

```

#Data availability/Sampling effort checking

We can look at effort by: total number of records and average number of species seen per sampling day ("list length")

```{r}

library(sparta)

dataDiagnostics(taxa= as.character(df$Species), 
                site= as.character(df$MTB_Q), 
                time_period = df$Date)

#both list length and number of records increase over time

```

Summary info per species

```{r}

library(plyr)
(outSummary <- ddply(df,.(Species),summarise,
                     nuRecs=length(unique(Date)),
                     nuYears=length(unique(Year)),
                     nuSites=length(unique(MTB_Q))))

```

Organise data using the sparta wrapper function

```{r, results='asis'}

source('R/sparta_wrapper_functions.R')

#define a visit
df$visit <- paste(df$MTB_Q,df$Date,df$Beobachter,sep="_")

occMatrix <- getOccurrenceMatrix(df)
listlengthDF <- getListLength(df)

#checks
all(row.names(occMatrix)==listlengthDF$surveyList)
listlengthDF[1:10,]

#plots
library(ggplot2)
qplot(nuSpecies,nuRecords,data=listlengthDF)
qplot(nuSpecies,RpS,data=listlengthDF)

```

Compile data for bugs (for a select species  - here )

```{r}

mySpecies<-"Pyrrhosoma nymphula"

bugs.data <- list(nsite = length(unique(listlengthDF$siteIndex)),
                  nyear = length(unique(listlengthDF$yearIndex)),
                  nvisit = nrow(listlengthDF),
                  site = listlengthDF$siteIndex,
                  year = listlengthDF$yearIndex,
                  yday = listlengthDF$day - median(listlengthDF$day),
                  nuSpecies = log(listlengthDF$nuSpecies) - log(median(listlengthDF$nuSpecies)),
                  nuRecs = log(listlengthDF$nuRecords) - log(median(listlengthDF$nuRecords)),
                  nuSS = listlengthDF$samplingSites - median(listlengthDF$samplingSites),# up to 3
                  expertise = log(listlengthDF$expertise)-median(log(listlengthDF$expertise)),
                  RpS = log(listlengthDF$RpS) - median(log(listlengthDF$RpS)),
                  y = as.numeric(occMatrix[,mySpecies]))

listlengthDF$Species <- bugs.data$y
                  
#need to specify initial values
library(reshape2)
zst <- acast(listlengthDF, siteIndex~yearIndex, value.var="Species",fun=max)
zst [is.infinite(zst)] <- 0
inits <- function(){list(z = zst)}

```

Look at the data:

Phenology:

```{r,results='asis'}

library(ggplot2)

#phenology pattern
library(plyr)
monthSums <- ddply(listlengthDF,.(month,Year),summarise,prevalence=sum(Species))
qplot(month,prevalence,data=monthSums)+facet_wrap(~Year,scale="free_y")#quadratic term seems reasonable

#time series trend
yearSums <- ddply(listlengthDF,.(Year,MTB_Q),summarise,total=sum(Species),
                  totRecs=sum(nuRecords),totSpe=sum(nuSpecies))

qplot(Year,total/totRecs,data=yearSums,colour=MTB_Q)
qplot(Year,total/totSpe,data=yearSums,colour=MTB_Q)

```


Run model with different effort terms

(1) with listlength as effort

```{r}

bugs.data$Effort <- bugs.data$nuSpecies

source('R/BUGS_misc_functions.R')

#specify parameters to monitor
params <- c("phenol.p","phenol2.p","effort.p","psi.fs")

#run model
out1 <- jags(bugs.data, inits=inits, params, "R/BUGS_sparta.txt", n.thin=nt,
               n.chains=3, n.burnin=4000,n.iter=20000,parallel=T)

print(out1,2)

#             mean    sd   2.5%    50%  97.5% overlap0    f Rhat n.eff
#phenol.p    -0.79  0.08  -0.97  -0.79  -0.65    FALSE 1.00 1.08    32
#phenol2.p    0.02  0.02  -0.02   0.02   0.06     TRUE 0.88 1.07    34
#effort.p     1.27  0.17   0.94   1.27   1.61    FALSE 1.00 1.01   355


```


(2) with records per species as a measure

```{r}

bugs.data$Effort <- bugs.data$RpS

source('R/BUGS_misc_functions.R')

#specify parameters to monitor
params <- c("phenol.p","phenol2.p","effort.p","psi.fs")

#run model
out1 <- jags(bugs.data, inits=inits, params, "R/BUGS_sparta.txt", n.thin=nt,
               n.chains=3, n.burnin=4000,n.iter=20000,parallel=T)

print(out1,2)
#             mean    sd   2.5%    50%  97.5% overlap0    f Rhat n.eff
#phenol.p    -0.86  0.09  -1.05  -0.86  -0.70    FALSE 1.00 1.03    83
#phenol2.p    0.02  0.02  -0.02   0.02   0.06     TRUE 0.87 1.04    54
#effort.p     1.03  0.16   0.73   1.03   1.35    FALSE 1.00 1.01   172

```

(3) add in an experise effect

```{r}

bugs.data$Effort <- bugs.data$nuSpecies

source('R/BUGS_misc_functions.R')

#specify parameters to monitor
params <- c("phenol.p","phenol2.p","effort.p","expert.p","psi.fs")

#run model
out1 <- jags(bugs.data, inits=inits, params, "R/BUGS_sparta.txt", n.thin=nt,
               n.chains=3, n.burnin=4000,n.iter=20000,parallel=T)

#             mean    sd   2.5%    50%  97.5% overlap0    f Rhat n.eff
#phenol.p    -0.81  0.08  -0.98  -0.80  -0.66    FALSE 1.00 1.06    40
#phenol2.p    0.02  0.02  -0.02   0.02   0.06     TRUE 0.89 1.05    50
#effort.p     1.17  0.20   0.78   1.16   1.57    FALSE 1.00 1.00  1175
#expert.p     0.10  0.10  -0.09   0.10   0.30     TRUE 0.84 1.00   804

```

(4) add in number of sampling sites

```{r}

bugs.data$Effort <- bugs.data$nuSpecies

source('R/BUGS_misc_functions.R')

#specify parameters to monitor
params <- c("phenol.p","phenol2.p","effort.p","effort2.p","ss.p","psi.fs")

#run model
out1 <- jags(bugs.data, inits=inits, params, "R/BUGS_sparta.txt", n.thin=nt,
               n.chains=3, n.burnin=4000,n.iter=20000,parallel=T)

#             mean    sd   2.5%    50%  97.5% overlap0    f Rhat n.eff
#phenol.p    -0.80  0.08  -0.97  -0.79  -0.64    FALSE 1.00 1.05    47
#phenol2.p    0.02  0.02  -0.02   0.02   0.06     TRUE 0.89 1.04    50
#effort.p     0.76  0.48  -0.14   0.75   1.73     TRUE 0.95 1.01   291
#effort2.p    0.25  0.25  -0.26   0.26   0.74     TRUE 0.84 1.01   349
#ss.p         0.27  0.20  -0.11   0.27   0.66     TRUE 0.92 1.02   141

```

(5) all detection variables together

```{r}

bugs.data$Effort <- bugs.data$nuSpecies
bugs.data$Effort_v2 <- bugs.data$RpS

source('R/BUGS_misc_functions.R')

#specify parameters to monitor
params <- c("phenol.p","phenol2.p","effort.p","effort_2.p","expert.p","ss.p","psi.fs")

#run model
out1 <- jags(bugs.data, inits=inits, params, "R/BUGS_sparta.txt", n.thin=nt,
               n.chains=3, n.burnin=4000,n.iter=20000,parallel=T)

print(out1,2)
#             mean    sd   2.5%    50%  97.5% overlap0    f Rhat n.eff
#phenol.p    -0.82  0.08  -0.99  -0.82  -0.67    FALSE 1.00 1.00  4756
#phenol2.p    0.03  0.02  -0.01   0.03   0.06     TRUE 0.93 1.00  3387
#effort.p     1.22  0.38   0.47   1.22   1.98    FALSE 1.00 1.01   334
#effort_2.p  -0.12  0.35  -0.81  -0.12   0.57     TRUE 0.64 1.01   379
#expert.p     0.10  0.10  -0.10   0.10   0.31     TRUE 0.83 1.00 24000
#ss.p         0.17  0.16  -0.15   0.17   0.49     TRUE 0.85 1.00  5198

```


#Run models over multiple species

Pull out 20 most common Species

```{r}

outSummary <- arrange(outSummary,desc(nuRecs))
(mySpecies <- outSummary$Species[1:20])
outSummary$nuRecs[1:20]

```

Write general function:

```{r}

fitBugs<-function(mySpecies,effort="nuSpecies",modelfile="R/BUGS_sparta.txt"){
  
#organise data
bugs.data <- list(nsite = length(unique(listlengthDF$siteIndex)),
                  nyear = length(unique(listlengthDF$yearIndex)),
                  nvisit = nrow(listlengthDF),
                  site = listlengthDF$siteIndex,
                  year = listlengthDF$yearIndex,
                  yday = listlengthDF$day - median(listlengthDF$day),
                  nuSpecies = log(listlengthDF$nuSpecies) - log(median(listlengthDF$nuSpecies)),
                  nuRecs = log(listlengthDF$nuRecords) - log(median(listlengthDF$nuRecords)),
                  nuSS = listlengthDF$samplingSites - median(listlengthDF$samplingSites),# up to 3
                  expertise = log(listlengthDF$expertise)-median(log(listlengthDF$expertise)),
                  RpS = log(listlengthDF$RpS) - median(log(listlengthDF$RpS)),
                  y = as.numeric(occMatrix[,mySpecies]))
listlengthDF$Species <- bugs.data$y
                  
#specify initial values
library(reshape2)
zst <- acast(listlengthDF, siteIndex~yearIndex, value.var="Species",fun=max)
zst [is.infinite(zst)] <- 0
inits <- function(){list(z = zst)}

#fit model
bugs.data$Effort <- bugs.data[[effort]]
bugs.data$Effort_v2 <- bugs.data$RpS

source('R/BUGS_misc_functions.R')

#specify parameters to monitor
params <- c("phenol.p","phenol2.p","effort.p","effort_2.p","expert.p","ss.p","psi.fs")

#run model
out1 <- jags(bugs.data, inits=inits, params, modelfile, n.thin=nt,
               n.chains=3, n.burnin=4000,n.iter=20000,parallel=T)

return(out1)
}


```

Run model with effort with all effort terms
```{r}

#run out each species
out <-llply(mySpecies,function(x){
  fitBugs(mySpecies=x)
})

save(out,file="out_nuSpecies_All.RData")

```


Extract info on each effort term
```{r}

load("model-outputs/out_nuSpecies_All.RData")
out2 <- combineModels(out)
out_nuSpecies <- getBUGSfits(out2,param="effort.p") 
out_RpS <- getBUGSfits(out2,param="effort_2.p")
out_Expertise <- getBUGSfits(out2,param="ss.p") 
out_nuSS <- getBUGSfits(out2,param="expert.p")

#combine all

out <-  rbind(out_nuSpecies,out_RpS,out_Expertise,out_nuSS)

#plotting
ggplot(out)+
  geom_crossbar(aes(x=Species,y=mean,ymin=X2.5.,ymax=X97.5.))+
  coord_flip()+
  facet_wrap(~Param,scales="free")+
  geom_hline(yintercept=0,col="red",linetype="dashed")

```

Get annual indices

```{r}

load("model-outputs/out_nuSpecies_All.RData")
out2 <- combineModels(out)
outAnnual <- getBUGSfits(out2,param="psi.fs") 
outAnnual$Year <- outAnnual$ParamNu + 1982

```

Plotting as separate times series

```{r}

library(ggplot2)
ggplot(outAnnual)+
  geom_line(aes(x=Year,y=mean))+
  geom_ribbon(aes(x=Year,ymin=X2.5., ymax=X97.5.),alpha=0.5)+
  facet_wrap(~Species)+
  theme_classic()+
  ylab("Predicted occupancy proportion")

```

Categorise trends

```{r}

load("model-outputs/out_RpS_Expertise_trends.RData")
out2 <- combineModels(out)
outTrends <- getBUGSfits(out2,param="trend.year") 
outTrends$Trend.type <- NA
outTrends$Trend.type[which(outTrends$X2.5.<0 & outTrends$X97.5.>0)]<- "no change"
outTrends$Trend.type[which(outTrends$X2.5.<0 & outTrends$X97.5.<0)]<- "decreasing"
outTrends$Trend.type[which(outTrends$X2.5.>0 & outTrends$X97.5.>0)]<- "increasing"

```

Plotting as separate times series

```{r}

library(ggplot2)
ggplot(outAnnual)+
  geom_line(aes(x=Year,y=mean,colour=Trend.type))+
  geom_ribbon(aes(x=Year,ymin=X2.5., ymax=X97.5.,fill=Trend.type),alpha=0.5)+
  facet_wrap(~Species)+
  theme_classic()+
  ylab("Predicted occupancy proportion")

```

Plotting as trend type

```{r}

outAnnual$Trend.type <- factor(outAnnual$Trend.type,levels=c("decreasing",
                                                             "no change",
                                                             "increasing"))
library(ggplot2)
ggplot(outAnnual)+
  geom_line(aes(x=Year,y=mean,group=Species))+
  facet_wrap(~Trend.type)+
  theme_classic()+
  theme(legend.position="none")+
  ylab("Predicted occupancy proportion")

```

Plotting effort relationships

```{r}

load("model-outputs/out_nuSpecies_Expertise_trends.RData")
out2 <- combineModels(out)
outTrends <- getBUGSfits(out2,param="effort.p") 
outTrends2 <- getBUGSfits(out2,param="effort2.p")

#Ischnura elegans

library(boot)
nuSpecies<--4:20
detection <- sapply(nuSpecies,function(x) 0 + (outTrends$mean[1]*x + outTrends2$mean[1]*x^2))

df<-data.frame(nuSpecies = nuSpecies+5,detection=inv.logit(detection))
q1<-qplot(nuSpecies,detection,data=df) + xlab("number of species")+ylab("detection probability")

outTrends2 <- getBUGSfits(out2,param="expertise.p")
library(boot)
nuSpecies<--5:5
detection <- sapply(nuSpecies,function(x) 0 + (0.11*x))
df<-data.frame(nuSpecies = nuSpecies+5,detection=inv.logit(detection))
q2<-qplot(nuSpecies,detection,data=df) + xlab("observer expertise (log records)")+ylab("detection probability")


library(cowplot)
plot_grid(q1,q2,align="v",ncol=1)

```

Model checking

```{r}

print(out1,3)
traceplot(out1)

```

Extended model checking

```{r}

#save(out1,file=paste0("model-outputs/out1_",mySpecies,".RData"))

#other graphs
#see http://xavier-fim.net/packages/ggmcmc/
library(ggmcmc)
bayes.mod.fit.gg <- ggs(out1$samples,family="psi.fs")
bayes.mod.fit.gg$ParamNu <- as.numeric(sub(".*\\[([^][]+)].*", "\\1", bayes.mod.fit.gg$Parameter))

#save the attribites becasue they are lost in the subsetting step below, dont understand why..
my_attributes<-attributes(bayes.mod.fit.gg)
bayes.mod.fit.gg <- subset(bayes.mod.fit.gg,ParamNu%%5==0)#plot every 5
attributes(bayes.mod.fit.gg)<-c(attributes(bayes.mod.fit.gg),my_attributes[3:8])

#plots
ggs_histogram(bayes.mod.fit.gg)
ggs_density(bayes.mod.fit.gg)
ggs_traceplot(bayes.mod.fit.gg)

```

Also extract z to look at spatial patterns

```{r}
out2<-update(out1,parameters.to.save="z",n.iter=1000)

#pull out site and year
zSummary<-data.frame(out2$summary[grepl("z",row.names(out2$summary)),])
zSummary$ParamNu <- as.character(sub(".*\\[([^][]+)].*", "\\1", row.names(zSummary)))
zSummary$Site<-sapply(zSummary$ParamNu,function(x)strsplit(x,",")[[1]][1])
zSummary$Year<-sapply(zSummary$ParamNu,function(x)strsplit(x,",")[[1]][2])

#create a site Info dataset
allData<-expand.grid(MTB_Q=unique(df$MTB_Q),Year=unique(df$Year))
allData$lon<-df$lon[match(allData$MTB_Q,df$MTB_Q)]
allData$lat<-df$lat[match(allData$MTB_Q,df$MTB_Q)]
allData$siteIndex<-listlengthDF$siteIndex[match(allData$MTB_Q,listlengthDF$site)]
allData$yearIndex<-listlengthDF$yearIndex[match(allData$Year,listlengthDF$year)]
allData$meanProp<-zSummary$mean[match(interaction(allData$siteIndex,allData$yearIndex),
                                           interaction(zSummary$Site,zSummary$Year))]
```

Plot spatial pattern in occupancy

```{r}

ggplot(subset(allData,Year%in% c(min(Year),max(Year))),
       aes(x=lon,y=lat))+
  geom_point(aes(colour=meanProp),size=rel(12),shape=15)+
  scale_colour_gradient(low="steelblue",high="red")+
  theme_bw()+
  facet_wrap(~Year)

```

